{
  "id": "snapshot_1762676843378_9w9h0zpy1",
  "approvalId": "approval_1762676810657_s3iwhvm56",
  "approvalTitle": "recommend-pipeline-streamline design",
  "version": 2,
  "timestamp": "2025-11-09T08:27:23.378Z",
  "trigger": "approved",
  "status": "pending",
  "content": "# Design Document\n\n## Overview\n\n本设计将 2025-11-09 recommend 管线修复正式化：\n1. HuggingFace 数据按分片拉取并以 LazyFrame 使用，封装在 `papersys/data_sources.py` 的辅助函数中，避免 CLI 直接处理下载逻辑。\n2. GitStore 负责外部仓库生命周期与 CSV 偏好文件管理，延迟初始化 SummaryStore 并去除 push 推荐快照的副作用。\n3. `Recommender` 全面接受 LazyFrame，在 join 后一次 collect，配合 CLI 的严格参数校验和输出管控，形成无副作用的推理流程。\n\n## Steering Document Alignment\n\n- `.spec-workflow/steering` 下暂无 product/tech/structure 文档，本设计沿用代码库现有约定：中文日志、Typer CLI、Pydantic 配置等。\n\n## Code Reuse Analysis\n\n### Existing Components to Leverage\n- **`papersys/data_sources.py`**：复用 `load_metadata/load_embeddings` 入口，在其上抽象 `_snapshot_shards`、`_load_sharded_dataset`、`_to_lazy`。\n- **`papersys/storage/git_store.py`**：继续使用 Git clone/pull 模式，只增强校验与 CSV 逻辑。\n- **`papersys/recommend/recommender.py`**：延续训练/预测实现，新增 LazyFrame 支持与 streaming collect。\n- **`papersys/cli/recommend_cmd.py`**： Typer CLI 结构保持不变，仅强化参数和输出。\n\n### Integration Points\n- **HuggingFace dataset**：通过 snapshot API 下载 `metadata_*`/`embedding_*` parquet，缓存到 `data/hf_cache/<repo>`，Polars scan 读取。\n- **外部 Git 仓库**：GitStore 负责 clone/fetch/pull、CSV 偏好读写以及 `summary_store` 的 `existing_ids`。\n- **Recommender ← CLI**：CLI 把 LazyFrame + 偏好 DF + 已总结 ID 注入到 Recommender，后者完成训练/预测并返回 `RecommendationResult`。\n\n## Architecture\n\n```\nTyper CLI (recommend_cmd)\n  ├─ load_config(AppConfig)\n  ├─ GitStore.ensure_local_copy()\n  ├─ load_metadata()/load_embeddings()  ← LazyFrame\n  ├─ GitStore.load_preferences() + summary_store.existing_ids()\n  ├─ Recommender.fit(categories)\n  └─ Recommender.predict(...)\n        └─ adaptive_sample + logistic regression\n```\n\n- **data_sources** 只负责下载缓存与 LazyFrame 创建；\n- **GitStore** 专注 Git + CSV；\n- **Recommender** 聚合元数据/向量 + 偏好，再筛除已处理 ID、过滤非法向量；\n- **CLI** 负责参数解析、日志、输出（JSONL/CSV）。\n\n## Components and Interfaces\n\n### `_repo_cache_dir(config: HuggingFaceDatasetConfig) -> Path`\n- 缓存目录以 `hf_repo` 派生，保证 metadata/embedding 共用逻辑。\n\n### `_snapshot_shards(config) -> str`\n- 调用 `snapshot_download` 下载 `shard_prefix_*.parquet`，若无匹配文件则报错。\n- 返回 glob pattern，供 Polars scan。\n\n### `_load_sharded_dataset(config, columns=None, lazy=False)`\n- 统一 metadata/embedding 读取逻辑，支持列裁剪和 LazyFrame。\n\n### `GitStore`\n- `ensure_local_copy`：若目录存在但非 git，清理后重新 clone。\n- `load_preferences/save_preferences`：改用 CSV，以 Polars DataFrame 输出，自动补列。\n- `summary_store`：惰性属性，首次访问才初始化 `SummaryStore`。\n\n### `Recommender`\n- 构造函数使用 `_to_lazy` 将 DataFrame 转 LazyFrame。\n- `_prepare_dataset` 只在 join 后 streaming collect。\n- 训练前校验正样本、背景样本、偏好数据；预测阶段过滤 `_preference_ids` 与 `_excluded_ids`。\n\n### CLI `recommend`\n- `_parse_date` 继续校验日期格式。\n- `effective_last_n`：优先参数，否则用配置。\n- 输出：仅允许 `.jsonl/.ndjson/.csv`，无输出则不写文件。\n\n## Data Models\n\n```\nHuggingFace metadata shard:\n  id: str\n  title: str\n  authors: list[str]\n  categories: list[str]\n  update_date: date\n  ...\n\nEmbedding shard:\n  id: str\n  embedding: list[float] (长度 dim)\n\nPreferences CSV:\n  id,preference\n  0000.12345,like\n```\n\n`RecommendationResult.frame` 包含 join 后字段 + `score` + `show`。CLI 将 `score` round(6)、`show`==1 的记录输出。\n\n## Error Handling\n\n1. **分片缺失**：`_snapshot_shards` 直接 `FileNotFoundError` + logger.error，包含仓库与模式。\n2. **Git 仓库损坏**：`ensure_local_copy` 清理后重新 clone，并记录 warning。\n3. **偏好/正样本缺失**：`Recommender.fit` 抛 `ValueError`，CLI 捕捉并 `typer.Exit(1)`。\n4. **CLI 参数非法**：日期解析或 `--last-n-days` 与 `--start/--end` 冲突时抛 `BadParameter`；输出后缀非法同理。\n5. **预测无结果**：多个阶段记录 warning（无候选、全部排除、NaN embedding）。\n\n## Testing Strategy\n\n### Unit Testing\n- `data_sources`\n  - Mock `snapshot_download`，断言允许模式、空分片抛错。\n  - 验证 `columns` 参数只返回指定列。\n- `GitStore`\n  - 使用临时目录模拟非 git 路径，确保清理 + clone。\n  - CSV 读写：无文件返回空 DF，保存时补列。\n- `Recommender`\n  - 构造小型 LazyFrame，验证 `_to_lazy` 行为与 streaming collect。\n  - 测试 `_filter_nan_embeddings` 清理 NaN。\n\n### Integration Testing\n- CLI 在本地小数据集下运行：\n  - 成功路径：检查日志含 lazy 信息、输出文件格式正确。\n  - 参数冲突/非法输出：捕获 `BadParameter`。\n  - 无推荐：确保 warning 并无异常退出。\n\n### End-to-End Testing\n- 结合真实 GitStore 仓库 + 伪造 HF 分片：模拟 `uv run papersys recommend` 全流程，包含 clone、lazy join、训练、输出。\n",
  "fileStats": {
    "size": 5430,
    "lines": 123,
    "lastModified": "2025-11-09T08:26:47.906Z"
  },
  "comments": []
}