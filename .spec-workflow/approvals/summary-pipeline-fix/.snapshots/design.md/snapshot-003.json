{
  "id": "snapshot_1762679170300_11teu1fdo",
  "approvalId": "approval_1762679021745_kvr5zk76m",
  "approvalTitle": "summary-pipeline-fix design.md (rev)",
  "version": 3,
  "timestamp": "2025-11-09T09:06:10.299Z",
  "trigger": "approved",
  "status": "pending",
  "content": "# Design Document\n\n## Overview\n\n摘要 JSONL 仓库需要两项结构性改造：\n\n1. **写入分片从出版年份切换到“摘要发生月份 (UTC)”**，`summary_date` 为必填字段，缺失直接视为输入错误并阻断流程；最终落到 `summaries/<YYYY-MM>.jsonl`。\n2. **为每次批处理生成 `last.jsonl` 快照**，内容仅包含本批次的记录且顺序与输入一致，方便推荐/审计脚本直接消费“最新一次摘要”。\n3. **CLI 新增 `--input` 与 `--dry-run` 选项**：`--input` 统一作为推荐产物入口（自动根据后缀解析，向后兼容旧 `--parquet`），`--dry-run` 可跳过写仓库/提交，仅把结果输出到 `--output` 指定文件，便于调试。\n\n改造将集中在 `papersys/storage/summary_store.py` 及 `papersys/cli/summary_cmd.py`，保持 CLI→GitStore→文件仓库的链路不变，同时补充日志指引 touched 分片及快照路径。\n\n## Steering Document Alignment\n\n### Technical Standards (tech.md)\n- 虽无自定义 steering 文档，本方案沿用现有 `SummaryStore` / `GitStore` 模块化边界，继续使用 `Path`、`loguru`、`typer` 等既定依赖。\n- 通过新增纯函数式 partition 解析与 snapshot writer，确保逻辑可单测、符合 KISS/SOLID。\n\n### Project Structure (structure.md)\n- 仍在 `papersys/storage` 下封装持久化细节，CLI 只调 `summary_store` 公共接口；日志/CLI 输出规范保持 `loguru` + `typer.echo` 风格。\n- JSONL 文件命名维持 `summaries/` 子目录，避免破坏 Git 仓库期望的目录结构与 CI 同步脚本。\n\n## Code Reuse Analysis\n\n### Existing Components to Leverage\n- **`SummaryStore` (`papersys/storage/summary_store.py`)**：保留 `upsert_many` 入口与 `iter_records`/`existing_ids` 能力，在内部重写分片与写盘策略，但遵循“只 append、不覆盖、不去重”，仅在发现同一 `id` 重复时报 warning。\n- **`GitStore` (`papersys/storage/git_store.py`)**：继续提供 `summary_store` 实例以及 `commit_and_push` 用于数据仓库同步。\n- **`summary` CLI (`papersys/cli/summary_cmd.py`)**：沿用现有 records 构建流程，只在 upsert 结果后输出新增日志、透传 `records` 给 `last.jsonl` 写入，并新增 `--input/--dry-run` 处理。\n\n### Integration Points\n- **CLI → Storage**：`summary_cmd` 仍调用 `git_store.summary_store.upsert_many(records)`，该方法返回 `SummaryWriteReport`，CLI 用于日志展示 touched months 及 `last.jsonl`。\n- **Storage → Git Repo**：`summary_store.root` 下新增月度分片与 `last.jsonl`，`git_store.commit_and_push([...])` 自动纳入版本控制。\n\n## Architecture\n\n### 模块化方案\n1. **PartitionResolver**（私有 helper）\n   - 输入记录字典，输出 `PartitionKey`（`slug: str`, `source_field: str`）。\n   - 仅接受 `SUMMARY_DATE`，缺失或解析失败立即抛 `ValueError`；Slug 形如 `2024-11`。\n\n2. **MonthlyShardWriter**（`SummaryStore` 内部）\n   - 负责聚合 `records` 到 `Path('summaries/<slug>.jsonl')`。\n   - 先调用 `_validate_existing_file(path)` 确认历史 JSON 行可解析，否则立刻报错阻断；验证通过后直接 **append** 新行，不改动历史顺序。\n\n3. **LastSnapshotWriter**\n   - 始终写入 `summaries/last.jsonl`，内容为“当前批次 record list”，无历史合并，保证坏文件可被全量覆盖。\n\n4. **Batch Reporting**\n   - `SummaryStore.upsert_many` 返回 `SummaryWriteReport`（touched_months, batch_size, snapshot_path, duplicate_ids）。\n   - CLI 利用该报告输出 `logger.info(\"本次更新月度分片: ...\")` 以及重复 ID warning，满足可观测性需求。\n\n```mermaid\ngraph LR\n    A[CLI summary_cmd] --> B[SummaryStore.upsert_many]\n    B --> C[Monthly shard files<br/>summaries/2024-11.jsonl]\n    B --> D[Monthly shard files<br/>summaries/2024-12.jsonl]\n    B --> E[last.jsonl snapshot]\n    C -->|git add| F[GitStore.commit_and_push]\n    D -->|git add| F\n    E -->|git add| F\n```\n\n### Modular Design Principles\n- **Single File Responsibility**：`summary_store.py` 继续只负责 JSONL 底层 I/O，CLI 只 orchestrate pipeline。\n- **Component Isolation**：partition/snapshot helper 均为独立函数，便于针对性测试与复用。\n- **Service Layer Separation**：Git 操作仍留在 `GitStore`，不会因数据格式变更而耦合。\n- **Utility Modularity**：日期解析、JSON dump、写盘逻辑拆分为私有方法，避免跨函数共享可变状态。\n\n## Components and Interfaces\n\n### Component 1 — `SummaryStore`\n- **Purpose:** 接收批量记录，按月份写入 JSONL（append-only），并生成 `last.jsonl`。\n- **Interfaces:**\n  - `upsert_many(records: Iterable[Mapping[str, Any]]) -> SummaryWriteReport`\n  - `iter_records() -> Iterator[dict[str, Any]]`（兼容多版本记录）\n  - `existing_ids() -> set[str]`\n- **Dependencies:** `pathlib.Path`, `json`, `loguru`, `papersys.fields`。\n- **Reuses:** 继续在 `GitStore.summary_store` 内实例化，供 CLI/推荐命令使用。\n\n**Key internal changes:**\n1. `_target_file` 改为 `_partition_path(record) -> Path`，返回 `summaries/<YYYY-MM>.jsonl`。\n2. 新增 `_extract_month_slug(value: Any) -> str`，仅从 `SUMMARY_DATE` 解析 `YYYY-MM`，失败抛错。\n3. `_validate_existing_file(path)` 在 append 前逐行 `json.loads`，一旦失败抛 `ValueError` 并终止命令，提醒人工修复。\n4. `_append_records(path, records)` 直接以文本 append，保持“旧文件顺序 + 新批次顺序”。\n5. `_write_last_snapshot(records: Iterable[Mapping[str, Any]])`：直接按输入顺序写 JSONL。\n6. `SummaryWriteReport = dataclass`，字段：`batch_size: int`, `partition_paths: list[Path]`, `partition_slugs: list[str]`, `duplicate_ids: list[str]`, `snapshot_path: Path`。\n\n### Component 2 — `summary` CLI 调整\n- **Purpose:** 执行 OCR→LLM→存储流水线，并在保存阶段展示月度/快照路径，同时新增输入/调试选项。\n- **Interfaces:** 仍由 `typer` 注册 `papersys summary`。\n- **Dependencies:** `SummaryStore`, `GitStore`, `loguru`, `typer`。\n- **Reuses:** 复用 `summary_store.upsert_many`，新增日志片段：\n  ```python\n  report = summary_store.upsert_many(records)\n  logger.info(\"触达月度分片: {}\", \", \".join(sorted(report.partition_slugs)))\n  logger.info(\"最新快照: {} ({} 条)\", report.snapshot_path, report.batch_size)\n  if report.duplicate_ids:\n      logger.warning(\"重复摘要 ID: {}\", \", \".join(report.duplicate_ids))\n  ```\n- **New flags:**\n  - `--input PATH`（必填）：根据扩展名选择 parquet/csv/jsonl loader；仍保留 `--parquet` 作为隐藏兼容 alias。\n  - `--dry-run/--no-dry-run`：dry-run 时跳过 `GitStore.commit_and_push` 与 `summary_store` 持久化，只在内存里生成 summaries，并把结果写入 `--output` 指定文件，供快速审阅。\n  - `--output PATH`：与 `last.jsonl` 内容一致的导出副本；dry-run 下这是唯一产物，非 dry-run 也可用于额外备份。\n\n## Data Models\n\n### Summary Record（输入 JSONL 行）\n```\n{\n  \"id\": str,\n  \"title\": str | None,\n  \"publish_date\": str | date | None,\n  \"update_date\": str | date | None,\n  \"summary_date\": str | date,   # 必填，缺失视为错误\n  \"summary_model\": str,\n  ...  # 其他文本/数组字段\n}\n```\n\n### SummaryWriteReport\n```\n@dataclass\nclass SummaryWriteReport:\n    batch_size: int\n    partition_paths: list[Path]  # e.g. [root / \"2024-11.jsonl\"]\n    partition_slugs: list[str]   # [\"2024-11\"]\n    duplicate_ids: list[str]\n    snapshot_path: Path          # root / \"last.jsonl\"\n```\n\n## Error Handling\n\n1. **日期字段缺失/格式错误**\n   - **Handling:** `_extract_month_slug` 捕捉 `ValueError` 直接抛出，CLI 输出明确错误并退出，要求补齐 `summary_date`。\n   - **User Impact:** 请求方需修复输入数据后重试，杜绝生成未命名分片。\n\n2. **历史 JSONL 行损坏**\n   - **Handling:** `_validate_existing_file` 在 append 前遍历文件，一旦解析失败立即抛错并阻止写入。\n   - **User Impact:** 操作员收到报错后可手工修复坏文件或删除再重跑，避免悄悄吞损坏行。\n\n3. **写盘/权限失败**\n   - **Handling:** 捕捉 `OSError` 并抛回 CLI；命令行输出 `logger.error`，阻止 Git 提交。\n   - **User Impact:** 用户需要修复权限或磁盘问题后重试。\n\n4. **Dry-run 模式**\n   - **Handling:** `--dry-run` 自动跳过 Git 提交/JSONL append，只生成 `last.jsonl` 内容并写 `--output`，CLI 日志会强调“未写入仓库”。\n   - **User Impact:** 可以在不污染仓库的情况下审阅结果。\n\n## Testing Strategy\n\n### Unit Testing\n- 覆盖 `_extract_month_slug` 的多种输入（`date`, ISO 字符串），确保缺失/非法值会抛错。\n- 针对 `upsert_many` 使用临时目录断言：\n- 正确生成 `summaries/<yyyy-mm>.jsonl`。\n  - 同一记录多次写入不会去重，但 `SummaryWriteReport.duplicate_ids` 会记录警告。\n  - `last.jsonl` 仅包含本批次记录且顺序与输入一致。\n  - `_validate_existing_file` 在遇到坏行时抛错。\n\n### Integration Testing\n- 用 `tmp_path` 模拟 GitStore summary 根目录，调用 CLI 保存逻辑（mock summarize 阶段）并校验 append 行为/日志输出。\n- Dry-run 流程：确保不会触达仓库路径，只写 `--output`。\n- 确认 `SummaryStore.existing_ids()` 仍能正确解出 ID 集合。\n\n### End-to-End Testing\n- 执行 `papersys summary --input ... --dry-run --output tmp.jsonl` 的模拟，确保 CLI 日志包含“dry-run”提示，产物只落到 output。\n- 结合 `git_store.commit_and_push`，验证新增 `last.jsonl` 与月度分片 append 后的 git diff 符合预期。\n",
  "fileStats": {
    "size": 9705,
    "lines": 167,
    "lastModified": "2025-11-09T09:03:37.113Z"
  },
  "comments": []
}