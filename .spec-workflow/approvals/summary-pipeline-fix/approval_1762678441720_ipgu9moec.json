{
  "id": "approval_1762678441720_ipgu9moec",
  "title": "summary-pipeline-fix design.md",
  "filePath": ".spec-workflow/specs/summary-pipeline-fix/design.md",
  "type": "document",
  "status": "needs-revision",
  "createdAt": "2025-11-09T08:54:01.720Z",
  "category": "spec",
  "categoryName": "summary-pipeline-fix",
  "response": "Feedback Summary (6 comments):\n\nSpecific Text Comments:\n1. \"`summaries/unknown_month.jsonl`。\": summary_date 不应该缺失，缺失说明有问题了，这就是摘要触发时自动添加的日期，这个少了很不合理。\n2. \"改造将集中在 `papersys/storage/summary_store.py` 及 `pape...\": 我认为可以添加一个命令行选项 dry run，方便 debug，不污染仓库\n3. \"- **`SummaryStore` (`papersys/storage/summary_stor...\": 这个非常不合理，因为 summary 的期望是 append，甚至不改变顺序，设计目标就是在 jsonl 后面直接插入新的记录就好了，根本不是 upsert 的，也不去重。当然也可以检测一下重复，有重复论文还是少数情况，出个 warning 就行了\n4. \"unknown_month\": 还是那句话，不应该有 unknown\n5. \"顺序整体覆盖写回\": 感觉没必要覆盖写回吧，append 就行了。当然一个，要验证老文件合法性，如果不合法我觉得可以直接报错退出，提示人工接入了。这个验证可以在一开始做，只需要验证本次要修改的文件就行了，last.jsonl 不用管，毕竟直接覆盖。\n6. \"parquet\": 这里用 parquet 作为 cli 的入参感觉还是不合适，我还是觉得用 --input  和 --output 更合理。--output 可以作为所有保存选项之外的，额外写入文件，内容和 last.jonsl 一致即可，比如可以dry run + output 临时把推荐内容导出到一个独立文件中\n",
  "annotations": "{\n  \"decision\": \"needs-revision\",\n  \"comments\": [\n    {\n      \"type\": \"selection\",\n      \"comment\": \"summary_date 不应该缺失，缺失说明有问题了，这就是摘要触发时自动添加的日期，这个少了很不合理。\",\n      \"timestamp\": \"2025-11-09T08:55:44.059Z\",\n      \"selectedText\": \"`summaries/unknown_month.jsonl`。\",\n      \"highlightColor\": {\n        \"bg\": \"rgba(255, 235, 59, 0.3)\",\n        \"border\": \"#FFEB3B\",\n        \"name\": \"#ffeb3b\"\n      },\n      \"id\": \"comment_1762678544059_n95et4ve7\"\n    },\n    {\n      \"type\": \"selection\",\n      \"comment\": \"我认为可以添加一个命令行选项 dry run，方便 debug，不污染仓库\",\n      \"timestamp\": \"2025-11-09T08:56:26.909Z\",\n      \"selectedText\": \"改造将集中在 `papersys/storage/summary_store.py` 及 `papersys/cli/summary_cmd.py`，保持 CLI→GitStore→文件仓库的链路不变，同时补充日志指引 touched 分片及快照路径。\",\n      \"highlightColor\": {\n        \"bg\": \"rgba(255, 235, 59, 0.3)\",\n        \"border\": \"#FFEB3B\",\n        \"name\": \"#ffeb3b\"\n      },\n      \"id\": \"comment_1762678586909_x6v6l1gsp\"\n    },\n    {\n      \"type\": \"selection\",\n      \"comment\": \"这个非常不合理，因为 summary 的期望是 append，甚至不改变顺序，设计目标就是在 jsonl 后面直接插入新的记录就好了，根本不是 upsert 的，也不去重。当然也可以检测一下重复，有重复论文还是少数情况，出个 warning 就行了\",\n      \"timestamp\": \"2025-11-09T08:58:16.905Z\",\n      \"selectedText\": \"- **`SummaryStore` (`papersys/storage/summary_store.py`)**：保留 `upsert_many` 入口与 `iter_records`/`existing_ids` 能力，在内部重写分片与写盘策略。\",\n      \"highlightColor\": {\n        \"bg\": \"rgba(255, 61, 61, 0.3)\",\n        \"border\": \"#ff3d3d\",\n        \"name\": \"#ff3d3d\"\n      },\n      \"id\": \"comment_1762678670807_gnumv9mhi\"\n    },\n    {\n      \"type\": \"selection\",\n      \"comment\": \"还是那句话，不应该有 unknown\",\n      \"timestamp\": \"2025-11-09T08:58:54.993Z\",\n      \"selectedText\": \"unknown_month\",\n      \"highlightColor\": {\n        \"bg\": \"rgba(255, 235, 59, 0.3)\",\n        \"border\": \"#FFEB3B\",\n        \"name\": \"#ffeb3b\"\n      },\n      \"id\": \"comment_1762678734993_fw4p2zzc9\"\n    },\n    {\n      \"type\": \"selection\",\n      \"comment\": \"感觉没必要覆盖写回吧，append 就行了。当然一个，要验证老文件合法性，如果不合法我觉得可以直接报错退出，提示人工接入了。这个验证可以在一开始做，只需要验证本次要修改的文件就行了，last.jsonl 不用管，毕竟直接覆盖。\",\n      \"timestamp\": \"2025-11-09T09:00:43.282Z\",\n      \"selectedText\": \"顺序整体覆盖写回\",\n      \"highlightColor\": {\n        \"bg\": \"rgba(255, 235, 59, 0.3)\",\n        \"border\": \"#FFEB3B\",\n        \"name\": \"#ffeb3b\"\n      },\n      \"id\": \"comment_1762678843282_5pjd2t1ji\"\n    },\n    {\n      \"type\": \"selection\",\n      \"comment\": \"这里用 parquet 作为 cli 的入参感觉还是不合适，我还是觉得用 --input  和 --output 更合理。--output 可以作为所有保存选项之外的，额外写入文件，内容和 last.jonsl 一致即可，比如可以dry run + output 临时把推荐内容导出到一个独立文件中\",\n      \"timestamp\": \"2025-11-09T09:02:30.998Z\",\n      \"selectedText\": \"parquet\",\n      \"highlightColor\": {\n        \"bg\": \"rgba(255, 235, 59, 0.3)\",\n        \"border\": \"#FFEB3B\",\n        \"name\": \"#ffeb3b\"\n      },\n      \"id\": \"comment_1762678950998_nt0yxfok7\"\n    }\n  ],\n  \"summary\": \"Feedback Summary (6 comments):\\n\\nSpecific Text Comments:\\n1. \\\"`summaries/unknown_month.jsonl`。\\\": summary_date 不应该缺失，缺失说明有问题了，这就是摘要触发时自动添加的日期，这个少了很不合理。\\n2. \\\"改造将集中在 `papersys/storage/summary_store.py` 及 `pape...\\\": 我认为可以添加一个命令行选项 dry run，方便 debug，不污染仓库\\n3. \\\"- **`SummaryStore` (`papersys/storage/summary_stor...\\\": 这个非常不合理，因为 summary 的期望是 append，甚至不改变顺序，设计目标就是在 jsonl 后面直接插入新的记录就好了，根本不是 upsert 的，也不去重。当然也可以检测一下重复，有重复论文还是少数情况，出个 warning 就行了\\n4. \\\"unknown_month\\\": 还是那句话，不应该有 unknown\\n5. \\\"顺序整体覆盖写回\\\": 感觉没必要覆盖写回吧，append 就行了。当然一个，要验证老文件合法性，如果不合法我觉得可以直接报错退出，提示人工接入了。这个验证可以在一开始做，只需要验证本次要修改的文件就行了，last.jsonl 不用管，毕竟直接覆盖。\\n6. \\\"parquet\\\": 这里用 parquet 作为 cli 的入参感觉还是不合适，我还是觉得用 --input  和 --output 更合理。--output 可以作为所有保存选项之外的，额外写入文件，内容和 last.jonsl 一致即可，比如可以dry run + output 临时把推荐内容导出到一个独立文件中\\n\",\n  \"timestamp\": \"2025-11-09T09:02:38.301Z\"\n}",
  "respondedAt": "2025-11-09T09:02:38.312Z",
  "comments": [
    {
      "type": "selection",
      "comment": "summary_date 不应该缺失，缺失说明有问题了，这就是摘要触发时自动添加的日期，这个少了很不合理。",
      "timestamp": "2025-11-09T08:55:44.059Z",
      "selectedText": "`summaries/unknown_month.jsonl`。",
      "highlightColor": {
        "bg": "rgba(255, 235, 59, 0.3)",
        "border": "#FFEB3B",
        "name": "#ffeb3b"
      },
      "id": "comment_1762678544059_n95et4ve7"
    },
    {
      "type": "selection",
      "comment": "我认为可以添加一个命令行选项 dry run，方便 debug，不污染仓库",
      "timestamp": "2025-11-09T08:56:26.909Z",
      "selectedText": "改造将集中在 `papersys/storage/summary_store.py` 及 `papersys/cli/summary_cmd.py`，保持 CLI→GitStore→文件仓库的链路不变，同时补充日志指引 touched 分片及快照路径。",
      "highlightColor": {
        "bg": "rgba(255, 235, 59, 0.3)",
        "border": "#FFEB3B",
        "name": "#ffeb3b"
      },
      "id": "comment_1762678586909_x6v6l1gsp"
    },
    {
      "type": "selection",
      "comment": "这个非常不合理，因为 summary 的期望是 append，甚至不改变顺序，设计目标就是在 jsonl 后面直接插入新的记录就好了，根本不是 upsert 的，也不去重。当然也可以检测一下重复，有重复论文还是少数情况，出个 warning 就行了",
      "timestamp": "2025-11-09T08:58:16.905Z",
      "selectedText": "- **`SummaryStore` (`papersys/storage/summary_store.py`)**：保留 `upsert_many` 入口与 `iter_records`/`existing_ids` 能力，在内部重写分片与写盘策略。",
      "highlightColor": {
        "bg": "rgba(255, 61, 61, 0.3)",
        "border": "#ff3d3d",
        "name": "#ff3d3d"
      },
      "id": "comment_1762678670807_gnumv9mhi"
    },
    {
      "type": "selection",
      "comment": "还是那句话，不应该有 unknown",
      "timestamp": "2025-11-09T08:58:54.993Z",
      "selectedText": "unknown_month",
      "highlightColor": {
        "bg": "rgba(255, 235, 59, 0.3)",
        "border": "#FFEB3B",
        "name": "#ffeb3b"
      },
      "id": "comment_1762678734993_fw4p2zzc9"
    },
    {
      "type": "selection",
      "comment": "感觉没必要覆盖写回吧，append 就行了。当然一个，要验证老文件合法性，如果不合法我觉得可以直接报错退出，提示人工接入了。这个验证可以在一开始做，只需要验证本次要修改的文件就行了，last.jsonl 不用管，毕竟直接覆盖。",
      "timestamp": "2025-11-09T09:00:43.282Z",
      "selectedText": "顺序整体覆盖写回",
      "highlightColor": {
        "bg": "rgba(255, 235, 59, 0.3)",
        "border": "#FFEB3B",
        "name": "#ffeb3b"
      },
      "id": "comment_1762678843282_5pjd2t1ji"
    },
    {
      "type": "selection",
      "comment": "这里用 parquet 作为 cli 的入参感觉还是不合适，我还是觉得用 --input  和 --output 更合理。--output 可以作为所有保存选项之外的，额外写入文件，内容和 last.jonsl 一致即可，比如可以dry run + output 临时把推荐内容导出到一个独立文件中",
      "timestamp": "2025-11-09T09:02:30.998Z",
      "selectedText": "parquet",
      "highlightColor": {
        "bg": "rgba(255, 235, 59, 0.3)",
        "border": "#FFEB3B",
        "name": "#ffeb3b"
      },
      "id": "comment_1762678950998_nt0yxfok7"
    }
  ]
}